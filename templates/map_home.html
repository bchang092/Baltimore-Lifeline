{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Baltimore Lifeline – Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg: #0f172a; --bg-2: #0b1220; --panel: #111827; --text: #e5e7eb;
      --muted: #9ca3af; --border: rgba(255,255,255,0.08); --shadow: rgba(0,0,0,0.35);
      --accent: #38bdf8; --accent-2: #10b981; --warning: #f59e0b; --danger: #ef4444;
    }
    html, body { height: 100%; margin: 0; }
    body {
      height: 100%;
      background: linear-gradient(180deg, var(--bg), var(--bg-2) 60%, #070b14);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.45;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    #map { height: 100vh; width: 100%; }

    .map-toolbar {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(17, 24, 39, 0.92); backdrop-filter: saturate(140%) blur(4px);
      padding: 10px 12px; border-radius: 12px; box-shadow: 0 8px 24px var(--shadow);
      border: 1px solid var(--border); max-width: min(90vw, 820px); color: var(--text);
    }
    .map-toolbar input, .map-toolbar button {
      font-size: 14px; padding: 8px 10px; margin-right: 6px; margin-top: 6px;
      border-radius: 10px; border: 1px solid var(--border);
      background: #0e1524; color: var(--text); outline: none;
    }
    .map-toolbar input::placeholder { color: #94a3b8; }
    .map-toolbar button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #081018; font-weight: 700; border: 0; cursor: pointer;
      box-shadow: 0 6px 16px rgba(56,189,248,0.25), 0 4px 10px rgba(16,185,129,0.20);
    }
    .legend { margin-top: 6px; font-size: 12px; line-height: 1.4; color: #cbd5e1; }
    .legend-item { display: inline-flex; align-items: center; margin-right: 12px; margin-top: 6px; }
    .legend-swatch { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.2) inset; }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .filter-pill {
      cursor: pointer;
      opacity: 0.85;
      background: rgba(15,23,42,0.9);
    }
    .filter-pill.active {
      opacity: 1;
      background: rgba(56,189,248,0.14);
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6) inset;
    }

    .leaflet-control-zoom a {
      background: #0e1524; color: var(--text); border: 1px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
    }
    .leaflet-control-zoom a:hover { background: #121a2d; }
    .leaflet-control-attribution {
      background: rgba(17,24,39,0.9); color: #cbd5e1; border: 1px solid var(--border);
      backdrop-filter: blur(4px);
    }
    .leaflet-container a { color: var(--accent); }

    .sidebar {
      position: absolute; z-index: 1100; top: 0; right: 0; height: 100%; width: min(420px, 92vw);
      background: linear-gradient(180deg, #0b1220, #0e1526); color: var(--text);
      box-shadow: -12px 0 28px rgba(0,0,0,0.45); border-left: 1px solid var(--border);
      transform: translateX(100%); transition: transform .28s ease; display: flex; flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); }
    .sidebar-title { margin: 0; font-size: 1.05rem; font-weight: 800; letter-spacing: .2px; }
    .sidebar-close { background: #0e1524; color: #cbd5e1; border: 1px solid var(--border);
      border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    .sidebar-body { padding: 14px 16px 18px; overflow-y: auto; }

    .sidebar a {
      color: #7dd3fc;              /* light blue links */
    }
    .sidebar a:hover {
      color: #bae6fd;
    }

    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; font-size: 12px;
      background: rgba(148,163,184,0.12); border: 1px solid var(--border); color: #cbd5e1; margin: 0 8px 10px 0; }
    .field { margin: 10px 0; color: #cbd5e1; }
    .label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 2px; }
    .link-btn { display: inline-flex; align-items: center; gap: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #081018; font-weight: 800; text-decoration: none; border-radius: 12px; padding: 10px 14px; margin-top: 8px;
      box-shadow: 0 6px 16px rgba(56,189,248,0.25), 0 4px 10px rgba(16,185,129,0.20); }

    @media (max-width: 640px) {
      .map-toolbar { left: 8px; right: 8px; max-width: calc(100vw - 16px); }
    }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div class="map-toolbar" role="region" aria-label="Map search and filters">
    <div>
      <input id="searchInput" type="text" placeholder="Search address or name of service" aria-label="Search" />
      <button id="resetBtn" type="button">Reset</button>
    </div>
    <div id="categoryTags" class="tag-container" aria-label="Filter by category"></div>
    <div class="legend" id="legend"></div>
  </div>

  <!-- Map -->
  <div id="map" role="application" aria-label="Resource map"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <div class="sidebar-header">
      <h3 class="sidebar-title" id="sidebar-title">Details</h3>
      <button id="sidebar-close" class="sidebar-close" type="button" aria-label="Close details">Close</button>
    </div>
    <div class="sidebar-body" id="sidebar-body"></div>
  </aside>

  <!-- Embed backend data -->
  {{ resources|json_script:"resources-data" }}

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const resources = JSON.parse(document.getElementById("resources-data").textContent);

    const map = L.map("map", { zoomControl: false });
    L.control.zoom({ position: "topright" }).addTo(map);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markerLayer = L.layerGroup().addTo(map);

    const PALETTE = ["#1e90ff","#28a745","#ff6b6b","#f59e0b","#a78bfa","#14b8a6","#f472b6","#ef4444","#22c55e","#60a5fa"];
    const categoryColorMap = new Map();
    function colorForCategory(cat) {
      if (!cat) return "#6c757d";
      if (!categoryColorMap.has(cat)) {
        categoryColorMap.set(cat, PALETTE[categoryColorMap.size % PALETTE.length]);
      }
      return categoryColorMap.get(cat);
    }

    // ----- Category tag filtering -----
    const activeCategories = new Set(); // empty => All

    function renderCategoryTags() {
      const categories = Array.from(new Set(resources.map(r => r.category).filter(Boolean))).sort();
      const container = document.getElementById("categoryTags");
      container.innerHTML = "";

      // "All" pill
      const allPill = document.createElement("button");
      allPill.type = "button";
      allPill.textContent = "All";
      allPill.className = "pill filter-pill active";
      allPill.dataset.category = "__ALL__";
      container.appendChild(allPill);

      // Category pills
      categories.forEach(c => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = c;
        btn.className = "pill filter-pill";
        btn.dataset.category = c;
        container.appendChild(btn);
      });

      // Click handler (event delegation)
      container.addEventListener("click", (e) => {
        const pill = e.target.closest(".filter-pill");
        if (!pill) return;
        const cat = pill.dataset.category;
        toggleCategory(cat);
      });
    }

    function updatePillStates() {
      const allPill = document.querySelector('.filter-pill[data-category="__ALL__"]');
      const usingAll = activeCategories.size === 0;

      if (allPill) {
        allPill.classList.toggle("active", usingAll);
      }

      document.querySelectorAll('.filter-pill').forEach(p => {
        const cat = p.dataset.category;
        if (cat === "__ALL__") return;
        p.classList.toggle("active", activeCategories.has(cat));
      });
    }

    function toggleCategory(cat) {
      if (cat === "__ALL__") {
        // Reset to "All" – clear specific selections
        activeCategories.clear();
      } else {
        if (activeCategories.has(cat)) {
          activeCategories.delete(cat);
        } else {
          activeCategories.add(cat);
        }
      }
      updatePillStates();
      applyFilters();
    }

    renderCategoryTags();

    function updateLegend(data) {
      const legend = document.getElementById("legend");
      const categories = Array.from(new Set(data.map(r => r.category).filter(Boolean))).sort();
      if (!categories.length) {
        legend.innerHTML = "";
        return;
      }
      legend.innerHTML = categories.map(c => (
        `<span class="legend-item">
           <span class="legend-swatch" style="background:${colorForCategory(c)}"></span>${c}
         </span>`
      )).join("");
    }

    // ----- Sidebar -----
    const sidebarEl = document.getElementById('sidebar');
    const sidebarTitleEl = document.getElementById('sidebar-title');
    const sidebarBodyEl = document.getElementById('sidebar-body');
    const sidebarCloseBtn = document.getElementById('sidebar-close');

    function pill(text, bg) {
      return `<span class="pill" style="border-color:${bg}; box-shadow:0 0 0 1px ${bg} inset;">${text}</span>`;
    }

    function openSidebar(r) {
      const dest = r.address ? encodeURIComponent(r.address) : `${r.lat},${r.lng}`;
      const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${dest}`;

      const catColor = colorForCategory(r.category);

      // RELIABILITY / STATUS
      let statusPill = "";
      const rawRel = (r.reliability || "").toString().trim().toLowerCase();
      const rating = parseFloat(rawRel);
      const hasNumericRating = !isNaN(rating);

      let showLowScoreDetails = false;

      if (hasNumericRating && rating >= 5) {
        statusPill = pill("Legit ✓", "#22c55e");
      } else if (hasNumericRating && rating < 5) {
        statusPill = pill("Not verified", "#f97316");
        showLowScoreDetails = true;
      } else {
        statusPill = pill("Not yet confirmed", "#f59e0b");
      }

      const phoneHtml = r.phone_number
        ? `<div class="field"><span class="label">Phone</span><div>${r.phone_number}</div></div>`
        : "";
      const emailHtml = r.email
        ? `<div class="field"><span class="label">Email</span><div><a href="mailto:${r.email}">${r.email}</a></div></div>`
        : "";
      const linkHtml = r.link
        ? `<div class="field"><span class="label">Website</span><div><a href="${r.link}" target="_blank" rel="noopener">${r.link}</a></div></div>`
        : "";
      const restrHtml = r.restrictions
        ? `<div class="field"><span class="label">Restrictions</span><div>${r.restrictions}</div></div>`
        : "";
      const daysHtml = r.days
        ? `<div class="field"><span class="label">Days</span><div>${r.days}</div></div>`
        : "";
      const notesHtml = (showLowScoreDetails && r.call_experience)
        ? `<div class="field"><span class="label">Call experience</span><div>${r.call_experience}</div></div>`
        : "";
      const metricsHtml = (showLowScoreDetails && r.metrics)
        ? `<div class="field"><span class="label">Metrics</span><div>${r.metrics}</div></div>`
        : "";

      sidebarTitleEl.textContent = r.name || "Unnamed resource";
      sidebarBodyEl.innerHTML = `
        <div class="pill" style="border-color:${catColor}; box-shadow: 0 0 0 1px ${catColor} inset;">
          <span style="width:10px;height:10px;border-radius:50%;background:${catColor};display:inline-block;"></span>
          <span>${r.category || 'Uncategorized'}</span>
        </div>
        ${statusPill}

        ${r.address ? `<div class="field"><span class="label">Address</span><div>${r.address}</div></div>` : ""}

        ${phoneHtml}
        ${emailHtml}
        ${linkHtml}

        ${r.description ? `<div class="field"><span class="label">Description</span><div>${r.description}</div></div>` : ""}

        ${restrHtml}
        ${daysHtml}
        ${notesHtml}
        ${metricsHtml}

        <a class="link-btn" href="${gmaps}" target="_blank" rel="noopener noreferrer">
          Open in Google Maps
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 12h12M13 6l6 6-6 6" stroke="#081018" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      `;

      sidebarEl.classList.add('open');
      sidebarEl.setAttribute('aria-hidden', 'false');
    }

    function closeSidebar() {
      sidebarEl.classList.remove('open');
      sidebarEl.setAttribute('aria-hidden', 'true');
    }

    sidebarCloseBtn.addEventListener('click', closeSidebar);
    map.on('click', closeSidebar);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });

    // ----- Markers + filters -----
    function addMarkers(data) {
      markerLayer.clearLayers();
      const bounds = [];

      data.forEach(r => {
        if (typeof r.lat !== "number" || typeof r.lng !== "number") return;

        const color = colorForCategory(r.category);
        const icon = L.divIcon({
          className: "custom-pin",
          html: `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36" width="24" height="36" aria-hidden="true" focusable="false">
              <path d="M12 0C5.4 0 0 5.4 0 12c0 7.5 12 24 12 24s12-16.5 12-24c0-6.6-5.4-12-12-12z"
                    fill="${color}" stroke="white" stroke-width="2"/>
            </svg>`,
          iconSize: [24, 36],
          iconAnchor: [12, 36],
        });

        const marker = L.marker([r.lat, r.lng], { icon });
        marker.on('click', () => openSidebar(r));
        marker.addTo(markerLayer);
        bounds.push([r.lat, r.lng]);
      });

      updateLegend(data);

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      } else {
        map.setView([39.2904, -76.6122], 11);
      }
    }

    const searchInput = document.getElementById("searchInput");
    const resetBtn = document.getElementById("resetBtn");

    function applyFilters() {
      const q = (searchInput.value || "").toLowerCase().trim();
      const useAllCats = activeCategories.size === 0;

      const filtered = resources.filter(r => {
        const inCat = useAllCats || activeCategories.has(r.category);
        const text = `${r.name || ""} ${r.address || ""}`.toLowerCase();
        const matches = !q || text.includes(q);
        return inCat && matches;
      });

      closeSidebar();
      addMarkers(filtered);
    }

    searchInput.addEventListener("input", applyFilters);
    resetBtn.addEventListener("click", () => {
      searchInput.value = "";
      activeCategories.clear();
      updatePillStates();
      closeSidebar();
      addMarkers(resources);
    });

    // Initial state: "All" categories, all markers visible
    updatePillStates();
    addMarkers(resources);
  </script>
</body>
</html>
