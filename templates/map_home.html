{% load static %}
<!doctype html>
<html lang="en">
<head>

  <meta charset="utf-8" />
  <title>Resource Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --bg: #0f172a;           /* slate-900 */
      --bg-2: #0b1220;         /* deep slate */
      --panel: #111827;        /* gray-900 */
      --text: #e5e7eb;         /* gray-200 */
      --muted: #9ca3af;        /* gray-400 */
      --border: rgba(255,255,255,0.08);
      --shadow: rgba(0,0,0,0.35);
      --accent: #38bdf8;       /* sky-400 */
      --accent-2: #10b981;     /* emerald-500 */
    }

    html, body { height: 100%; margin: 0; }
    body {
      height: 100%;
      background: linear-gradient(180deg, var(--bg), var(--bg-2) 60%, #070b14);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;

      /* mobile safe-area (notch) padding */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    #map { height: 100vh; width: 100%; }

    /* Dark toolbar */
    .map-toolbar {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(17, 24, 39, 0.92); /* var(--panel) with slight translucency */
      backdrop-filter: saturate(140%) blur(4px);
      padding: 10px 12px; border-radius: 12px;
      box-shadow: 0 8px 24px var(--shadow);
      border: 1px solid var(--border);
      max-width: min(90vw, 760px);
      color: var(--text);
    }
    .map-toolbar input, .map-toolbar select, .map-toolbar button {
      font-size: 14px; padding: 8px 10px; margin-right: 6px; margin-top: 6px;
      border-radius: 10px; border: 1px solid var(--border);
      background: #0e1524; color: var(--text);
      outline: none;
    }
    .map-toolbar input::placeholder { color: #94a3b8; }
    .map-toolbar button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #081018; font-weight: 700; border: 0; cursor: pointer;
      box-shadow: 0 6px 16px rgba(56,189,248,0.25), 0 4px 10px rgba(16,185,129,0.20);
    }
    .legend {
      margin-top: 6px; font-size: 12px; line-height: 1.4; color: #cbd5e1;
    }
    .legend-item {
      display: inline-flex; align-items: center; margin-right: 12px; margin-top: 6px;
    }
    .legend-swatch {
      width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.2) inset;
    }

    /* Dark Leaflet controls */
    .leaflet-control-zoom a {
      background: #0e1524; color: var(--text); border: 1px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
    }
    .leaflet-control-zoom a:hover { background: #121a2d; }
    .leaflet-control-attribution {
      background: rgba(17,24,39,0.9); color: #cbd5e1; border: 1px solid var(--border);
      backdrop-filter: blur(4px);
    }
    .leaflet-container a { color: var(--accent); }

    /* Sidebar panel */
    .sidebar {
      position: absolute; z-index: 1100; top: 0; right: 0; height: 100%;
      width: min(420px, 92vw);
      background: linear-gradient(180deg, #0b1220, #0e1526);
      color: var(--text);
      box-shadow: -12px 0 28px rgba(0,0,0,0.45);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform .28s ease;
      display: flex; flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .sidebar-title {
      margin: 0; font-size: 1.05rem; font-weight: 800; letter-spacing: .2px;
    }
    .sidebar-close {
      background: #0e1524; color: #cbd5e1; border: 1px solid var(--border);
      border-radius: 10px; padding: 6px 10px; cursor: pointer;
    }
    .sidebar-body {
      padding: 14px 16px 18px; overflow-y: auto;
    }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px; font-size: 12px;
      background: rgba(148,163,184,0.12); border: 1px solid var(--border);
      color: #cbd5e1; margin-bottom: 10px;
    }
    .field { margin: 10px 0; color: #cbd5e1; }
    .label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 2px; }
    .link-btn {
      display: inline-flex; align-items: center; gap: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #081018; font-weight: 800; text-decoration: none;
      border-radius: 12px; padding: 10px 14px; margin-top: 8px;
      box-shadow: 0 6px 16px rgba(56,189,248,0.25), 0 4px 10px rgba(16,185,129,0.20);
    }

    /* Custom pin container (SVG injected) */
    .custom-pin { /* no extra styles needed; keep for clarity */ }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      .map-toolbar { left: 8px; right: 8px; max-width: calc(100vw - 16px); }
    }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div class="map-toolbar" role="region" aria-label="Map search and filters">
    <div>
      <input id="searchInput" type="text" placeholder="Search address or name of service" aria-label="Search" />
      <select id="categoryFilter" aria-label="Filter by category">
        <option value="">All categories</option>
        <option value="Health">Health</option>
        <option value="Food">Food</option>
        <option value="Legal">Legal</option>
        <!-- more categories add here -->
      </select>
      <button id="resetBtn" type="button">Reset</button>
    </div>
    <div class="legend" id="legend"></div>
  </div>

  <!-- Map -->
  <div id="map" role="application" aria-label="Resource map"></div>

  <!-- Sidebar (hidden by default) -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <div class="sidebar-header">
      <h3 class="sidebar-title" id="sidebar-title">Details</h3>
      <button id="sidebar-close" class="sidebar-close" type="button" aria-label="Close details">Close</button>
    </div>
    <div class="sidebar-body" id="sidebar-body">
      <!-- Filled dynamically -->
    </div>
  </aside>

  <!-- Safely embed backend data (Django) -->
  {{ resources|json_script:"resources-data" }}

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Parse backend data
    const resources = JSON.parse(document.getElementById("resources-data").textContent);

    // Initialize map without zoom controls
    const map = L.map("map", { zoomControl: false });

    // Add zoom control on the top-right
    L.control.zoom({ position: "topright" }).addTo(map);

    // Base tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Layer for markers
    const markerLayer = L.layerGroup().addTo(map);

    // Category color map
    const CATEGORY_COLORS = {
      Health: "#1e90ff",
      Food: "#28a745",
      Legal: "#ff6b6b",
      default: "#6c757d",
    };
    const colorForCategory = (cat) => CATEGORY_COLORS[cat] || CATEGORY_COLORS.default;

    // Build legend
    (function renderLegend() {
      const legend = document.getElementById("legend");
      const entries = Object.keys(CATEGORY_COLORS).filter(k => k !== "default");
      legend.innerHTML = entries.map(k => (
        `<span class="legend-item">
           <span class="legend-swatch" style="background:${CATEGORY_COLORS[k]}"></span>${k}
         </span>`
      )).join("");
    })();

    // Sidebar helpers
    const sidebarEl = document.getElementById('sidebar');
    const sidebarTitleEl = document.getElementById('sidebar-title');
    const sidebarBodyEl = document.getElementById('sidebar-body');
    const sidebarCloseBtn = document.getElementById('sidebar-close');

    function openSidebar(resource) {
      const dest = resource.address ? encodeURIComponent(resource.address) : `${resource.lat},${resource.lng}`;
      const gmaps = `https://www.google.com/maps/dir/?api=1&destination=${dest}`;

      sidebarTitleEl.textContent = resource.name || 'Unnamed resource';
      const catColor = colorForCategory(resource.category);

      sidebarBodyEl.innerHTML = `
        <div class="pill" style="border-color:${catColor}; box-shadow: 0 0 0 1px ${catColor} inset;">
          <span style="width:10px;height:10px;border-radius:50%;background:${catColor};display:inline-block;"></span>
          <span>${resource.category || 'Uncategorized'}</span>
        </div>

        ${resource.address ? `
        <div class="field">
          <span class="label">Address</span>
          <div>${resource.address}</div>
        </div>` : ''}

        ${resource.phone_number ? `
        <div class="field">
          <span class="label">Phone</span>
          <div>${resource.phone_number}</div>
        </div>` : ''}

        ${resource.description ? `
        <div class="field">
          <span class="label">Description</span>
          <div>${resource.description}</div>
        </div>` : ''}

        <a class="link-btn" href="${gmaps}" target="_blank" rel="noopener noreferrer">
          Open in Google Maps
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 12h12M13 6l6 6-6 6" stroke="#081018" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      `;

      sidebarEl.classList.add('open');
      sidebarEl.setAttribute('aria-hidden', 'false');
    }

    function closeSidebar() {
      sidebarEl.classList.remove('open');
      sidebarEl.setAttribute('aria-hidden', 'true');
    }

    sidebarCloseBtn.addEventListener('click', closeSidebar);
    // Close when clicking empty map space
    map.on('click', closeSidebar);
    // Close on Escape
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSidebar(); });

    function addMarkers(data) {
      markerLayer.clearLayers();
      const bounds = [];

      data.forEach(r => {
        if (typeof r.lat !== "number" || typeof r.lng !== "number") return;

        const color = colorForCategory(r.category);

        // Custom colored pin icon (SVG)
        const icon = L.divIcon({
          className: "custom-pin",
          html: `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 36" width="24" height="36" aria-hidden="true" focusable="false">
              <path d="M12 0C5.4 0 0 5.4 0 12c0 7.5 12 24 12 24s12-16.5 12-24c0-6.6-5.4-12-12-12z"
                    fill="${color}" stroke="white" stroke-width="2"/>
            </svg>`,
          iconSize: [24, 36],
          iconAnchor: [12, 36],
        });

        const marker = L.marker([r.lat, r.lng], { icon });

        // Instead of bindPopup, open sidebar on click
        marker.on('click', () => openSidebar(r));

        marker.addTo(markerLayer);
        bounds.push([r.lat, r.lng]);
      });

      if (bounds.length) {
        map.fitBounds(bounds, { padding: [30, 30] });
      } else {
        map.setView([39.5, -98.35], 4);
      }
    }

    // Initial render
    addMarkers(resources);

    // Filters
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const resetBtn = document.getElementById("resetBtn");

    function applyFilters() {
      const q = (searchInput.value || "").toLowerCase().trim();
      const cat = categoryFilter.value;

      const filtered = resources.filter(r => {
        const inCat = !cat || r.category === cat;
        const text = `${r.name || ""} ${r.address || ""}`.toLowerCase();
        const matches = !q || text.includes(q);
        return inCat && matches;
      });

      closeSidebar();
      addMarkers(filtered);
    }

    searchInput.addEventListener("input", applyFilters);
    categoryFilter.addEventListener("change", applyFilters);
    resetBtn.addEventListener("click", () => {
      searchInput.value = "";
      categoryFilter.value = "";
      closeSidebar();
      addMarkers(resources);
    });
  </script>
</body>
</html>
